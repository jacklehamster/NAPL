function h(D){let{userId:q,appId:V,room:A,host:B,autoRejoin:J=!0,logLine:Y}=D,Z=!1,_=0,K,M,N=!0,$=new Map,L=`wss://${B}/room/${V}/${A}?userId=${encodeURIComponent(q)}`;function W(E,H,O){if(!K)return!1;if(Z||K.readyState!==WebSocket.OPEN)return!1;let z={type:E,to:H,payload:O};return K.send(JSON.stringify(z)),Y?.("\uD83D\uDC64 ➡️ \uD83D\uDDA5️",z),!0}function F(){if(Z)return;K=new WebSocket(L),K.onopen=()=>{if(N)D.onOpen?.(),N=!1;_=0},K.onmessage=(E)=>{try{let H=JSON.parse(E.data);(Array.isArray(H)?H:[H]).forEach((z)=>{if(Y?.("\uD83D\uDDA5️ ➡️ \uD83D\uDC64",z),z.type==="peer-joined"||z.type==="peer-left")P(z.users);else if(z.type==="ice-server")D.onIceUrl?.(z.url);else if(z.userId)D.onMessage(z.type,z.payload,{userId:z.userId,receive:(G,T)=>W(G,z.userId,T)})})}catch{Y?.("⚠️ ERROR",{error:"invalid-json"})}},K.onclose=(E)=>{let O=[1001,1006,1011,1012,1013].includes(E.code);if(J&&!Z&&O){let z=Math.min(Math.pow(2,_)*1000,30000),G=Math.random()*1000,T=z+G;Y?.("\uD83D\uDD04 RECONNECTING",{attempt:_+1,delayMs:Math.round(T)}),_++,M=setTimeout(F,T)}else D.onClose?.({code:E.code,reason:E.reason,wasClean:E.wasClean})},K.onerror=(E)=>{console.error("WS Error",E),D.onError?.()}}function P(E){let H=[],O=[],z=new Set;E.forEach(({userId:G})=>{if(G===q)return;if(!$.has(q)){let T={userId:G,receive:(R,b)=>W(R,G,b)};$.set(q,T),H.push(T)}z.add(q)});for(let G of $.keys())if(!z.has(G))$.delete(G),O.push({userId:G});if(H.length)D.onPeerJoined(H);if(O.length)D.onPeerLeft(O)}return F(),{exitRoom:()=>{Z=!0,clearTimeout(M),K.close()}}}var k=null,X=new Map;function Q(D){self.postMessage(D)}self.addEventListener("message",(D)=>{let q=D.data;if(console.debug("[signal-room.worker] received command",q),q.cmd==="enter"){k?.(),k=null,X.clear(),k=h({userId:q.userId,appId:q.appId,room:q.room,host:q.host,autoRejoin:q.autoRejoin,onOpen:()=>Q({kind:"open"}),onClose:({code:A,reason:B,wasClean:J})=>Q({kind:"close",ev:{code:A,reason:B,wasClean:J}}),onError:()=>Q({kind:"error"}),logLine:(A,B)=>{console.debug(`[signal-room.worker] ${A}`,B),Q({kind:"log",direction:A,obj:B})},onPeerJoined:(A)=>{A.forEach(({userId:B,receive:J})=>X.set(`${q.host}/${q.room}/${B}`,J)),Q({kind:"peer-joined",users:A.map(({userId:B})=>({userId:B}))})},onPeerLeft:(A)=>{A.forEach(({userId:B})=>X.delete(`${q.host}/${q.room}/${B}`)),Q({kind:"peer-left",users:A})},onIceUrl(A){Q({kind:"ice-server",url:A})},onMessage:(A,B,J)=>{X.set(`${q.host}/${q.room}/${J.userId}`,J.receive),Q({kind:"message",type:A,payload:B,fromUserId:J.userId})}}).exitRoom;return}if(q.cmd==="send"){let V=X.get(`${q.host}/${q.room}/${q.toUserId}`);if(V)V(q.type,q.payload);return}if(q.cmd==="exit"){k?.(),self.close();return}});

//# debugId=4EF0D5A1F88C12B664756E2164756E21
//# sourceMappingURL=signal-room.worker.js.map

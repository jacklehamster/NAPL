function h(E){let{userId:q,worldId:V,room:A,host:B,autoRejoin:J=!0,logLine:Z}=E,_=!1,$=0,K,W,F=!0,k=new Map,P=`wss://${B}/room/${V}/${A}?userId=${encodeURIComponent(q)}`;function N(D,G,O){if(!K)return!1;if(_||K.readyState!==WebSocket.OPEN)return!1;let z={type:D,to:G,payload:O};return K.send(JSON.stringify(z)),Z?.("\uD83D\uDC64 ➡️ \uD83D\uDDA5️",z),!0}function T(){if(_)return;K=new WebSocket(P),K.onopen=()=>{if(F)E.onOpen?.(),F=!1;$=0},K.onmessage=(D)=>{try{let G=JSON.parse(D.data);(Array.isArray(G)?G:[G]).forEach((z)=>{if(Z?.("\uD83D\uDDA5️ ➡️ \uD83D\uDC64",z),z.type==="peer-joined"||z.type==="peer-left")R(z.users);else if(z.type==="ice-server")E.onIceUrl?.(z.url);else if(z.userId)E.onMessage(z.type,z.payload,{userId:z.userId,receive:(H,X)=>N(H,z.userId,X)})})}catch{Z?.("⚠️ ERROR",{error:"invalid-json"})}},K.onclose=(D)=>{let O=[1001,1006,1011,1012,1013].includes(D.code);if(J&&!_&&O){let z=Math.min(Math.pow(2,$)*1000,30000),H=Math.random()*1000,X=z+H;Z?.("\uD83D\uDD04 RECONNECTING",{attempt:$+1,delayMs:Math.round(X)}),$++,W=setTimeout(T,X)}else E.onClose?.({code:D.code,reason:D.reason,wasClean:D.wasClean})},K.onerror=(D)=>{console.error("WS Error",D),E.onError?.()}}function R(D){let G=[],O=[],z=new Set;D.forEach(({userId:H})=>{if(H===q)return;if(!k.has(q)){let X={userId:H,receive:(b,x)=>N(b,H,x)};k.set(q,X),G.push(X)}z.add(q)});for(let H of k.keys())if(!z.has(H))k.delete(H),O.push({userId:H});if(G.length)E.onPeerJoined(G);if(O.length)E.onPeerLeft(O)}return T(),{sendToServer:(D,G)=>{N(D,"",G)},exitRoom:()=>{_=!0,clearTimeout(W),K.close()}}}var M=null,L,Y=new Map;function Q(E){self.postMessage(E)}self.addEventListener("message",(E)=>{let q=E.data;if(console.debug("[signal-room.worker] received command",q),q.cmd==="enter"){M?.(),M=null,Y.clear();let V=h({userId:q.userId,worldId:q.worldId,room:q.room,host:q.host,autoRejoin:q.autoRejoin,onOpen:()=>Q({kind:"open"}),onClose:({code:A,reason:B,wasClean:J})=>Q({kind:"close",ev:{code:A,reason:B,wasClean:J}}),onError:()=>Q({kind:"error"}),logLine:(A,B)=>{console.debug(`[signal-room.worker] ${A}`,B),Q({kind:"log",direction:A,obj:B})},onPeerJoined:(A)=>{A.forEach(({userId:B,receive:J})=>Y.set(`${q.host}/${q.room}/${B}`,J)),Q({kind:"peer-joined",users:A.map(({userId:B})=>({userId:B}))})},onPeerLeft:(A)=>{A.forEach(({userId:B})=>Y.delete(`${q.host}/${q.room}/${B}`)),Q({kind:"peer-left",users:A})},onIceUrl(A){Q({kind:"ice-server",url:A})},onMessage:(A,B,J)=>{Y.set(`${q.host}/${q.room}/${J.userId}`,J.receive),Q({kind:"message",type:A,payload:B,fromUserId:J.userId})}});M=V.exitRoom,L=V.sendToServer;return}if(q.cmd==="send"){if(q.toUserId){let V=Y.get(`${q.host}/${q.room}/${q.toUserId}`);if(V)V(q.type,q.payload)}else L?.(q.type,q.payload);return}if(q.cmd==="exit"){M?.(),self.close();return}});

//# debugId=FB163DC32CC1ABCA64756E2164756E21
//# sourceMappingURL=signal-room.worker.js.map

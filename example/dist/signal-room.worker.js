function U({userId:T,appId:z,room:V,host:B,onOpen:q,onClose:A,onError:Z,logLine:W,onPeerJoined:R,onPeerLeft:b,onMessage:v}){let x=`wss://${B}/room/${z}/${V}?userId=${encodeURIComponent(T)}`,D=new WebSocket(x),C=T,_=new Map,h=!1;function F(X,k,N){if(h)return!1;let H={type:X,to:k,payload:N};return D.send(JSON.stringify(H)),W?.("\uD83D\uDC64 ➡️ \uD83D\uDDA5️",H),!0}function L(X){let k=[],N=[],H=new Set;if(X.forEach(({userId:K,peerId:G})=>{if(K===C)return;if(!_.has(G)){let M={userId:K,peerId:G,receive:(O,S)=>F(O,G,S)};_.set(G,M),k.push(M)}H.add(G)}),_.values().forEach(({peerId:K,userId:G})=>{if(!H.has(K))_.delete(K),N.push({peerId:K,userId:G})}),k.length)R(k);if(N.length)b(N)}function J(X){let k;try{k=JSON.parse(X.data)}catch{W?.("⚠️ ERROR",{error:"invalid-json"});return}if(W?.("\uD83D\uDDA5️ ➡️ \uD83D\uDC64",k),k.type==="peer-joined"||k.type==="peer-left"){L(k.users);return}if(k.peerId&&k.userId){let{userId:N,peerId:H}=k;v(k.type,k.payload,{userId:N,peerId:H,receive:(K,G)=>F(K,H,G)})}}if(D.addEventListener("message",J),q)D.addEventListener("open",q);if(A)D.addEventListener("close",A);if(Z)D.addEventListener("error",Z);return{exitRoom:()=>{if(h=!0,D.close(),D.removeEventListener("message",J),q)D.removeEventListener("open",q);if(A)D.removeEventListener("close",A);if(Z)D.removeEventListener("error",Z)}}}var $=null,Y=new Map;function Q(T){self.postMessage(T)}self.addEventListener("message",(T)=>{let z=T.data;if(console.debug("[signal-room.worker] received command",z),z.cmd==="enter"){$?.(),$=null,Y.clear(),$=U({userId:z.userId,appId:z.appId,room:z.room,host:z.host,onOpen:()=>Q({kind:"open"}),onClose:()=>Q({kind:"close"}),onError:()=>Q({kind:"error"}),logLine:(B,q)=>{console.debug(`[signal-room.worker] ${B}`,q),Q({kind:"log",direction:B,obj:q})},onPeerJoined:(B)=>{B.forEach(({peerId:q,receive:A})=>Y.set(q,A)),Q({kind:"peer-joined",users:B.map(({userId:q,peerId:A})=>({userId:q,peerId:A}))})},onPeerLeft:(B)=>{B.forEach(({peerId:q})=>Y.delete(q)),Q({kind:"peer-left",users:B})},onMessage:(B,q,A)=>{Y.set(A.peerId,A.receive),Q({kind:"message",type:B,payload:q,fromUserId:A.userId,fromPeerId:A.peerId})}}).exitRoom;return}if(z.cmd==="send"){let V=Y.get(z.toPeerId);if(V)V(z.type,z.payload);return}if(z.cmd==="exit"){$?.(),self.close();return}});

//# debugId=B4D6FE1CAC5FA63564756E2164756E21
//# sourceMappingURL=signal-room.worker.js.map

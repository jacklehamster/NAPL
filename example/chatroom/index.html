<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Chat Room</title>
    <style>
      body {
        background-color: lightgray;
      }
      .users {
        position: absolute;
        right: 5px;
        top: 5px;
        z-index: 100;
      }
      .chat-log {
        position: absolute;
        left: 0;
        top: 0;
        padding: 10px;
        width: 100%;
        height: 100%;
        background-color: white;
        border: 1px solid black;
        overflow: auto;
      }
      .chat-box {
        position: absolute;
        left: 0;
        bottom: 0;
        width: calc(100% - 30px);
        margin: 10px;
        padding: 5px;
        background-color: silver;
        border: 1px solid black;
        height: 100px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="users"></div>
      <div class="chat-log"></div>
      <div class="chat-box" contenteditable="true"></div>
    </div>

    <script type="module">
      import { socketClient } from "../dist/index.js";

      window.socketClient = socketClient;

      document.querySelector(".chat-box").addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          const message = e.target.textContent;
          e.target.textContent = "";
          socketClient.setData(`chat`, message, {
            push: true,
          });
          e.preventDefault();
        }
      });

      socketClient.observe(["chat"]).onElementsAdded((elems) => {
        console.log(elems, "<<");
        elems.forEach((elem) => {
          const chatLog = document.querySelector(".chat-log");
          const chatMessage = document.createElement("div");
          chatMessage.textContent = elem;
          chatLog.appendChild(chatMessage);
          chatLog.scrollTop = chatLog.scrollHeight;
        });
      });

      socketClient.observe([]).onChange(() => {
        console.log(JSON.parse(JSON.stringify(socketClient.state)));
      });

      socketClient
        .observe(["clients/{keys}"])
        .onElementsAdded((clientIds) => {
          clientIds.forEach((clientId) => {
            // new client
            const client = document.createElement("div");
            client.id = `client-${clientId}`;
            client.textContent = clientId;
            if (clientId === socketClient.clientId) {
              client.style.fontWeight = "bold";
              client.style.backgroundColor = "yellow";
              document.querySelector(".users").prepend(client);
            } else {
              document.querySelector(".users").appendChild(client);
            }
          });
        })
        .onElementsDeleted((clientIds) => {
          clientIds.forEach((clientId) => {
            const client = document.querySelector(`#client-${clientId}`);
            client.style.transition = "opacity 0.3s";
            client.style.opacity = 0;
            setTimeout(() => {
              client.remove();
            }, 300);
          });
        });
    </script>
  </body>
</html>

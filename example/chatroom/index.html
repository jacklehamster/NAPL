<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Chat Room</title>
    <style>
      body {
        background-color: lightgray;
      }
      .users {
        position: absolute;
        right: 5px;
        top: 5px;
        z-index: 100;
      }
      .chat-log {
        position: absolute;
        left: 0;
        top: 0;
        padding: 10px;
        width: 100%;
        height: 100%;
        background-color: white;
        border: 1px solid black;
        overflow: auto;
      }
      .chat-box {
        position: absolute;
        left: 0;
        bottom: 0;
        width: calc(100% - 30px);
        margin: 10px;
        padding: 5px;
        background-color: silver;
        border: 1px solid black;
        height: 100px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="users"></div>
      <div class="chat-log"></div>
      <div class="chat-box" contenteditable="true"></div>
    </div>

    <script type="module">
      import { socketClient, randomEmoji, randomName } from "../dist/index.js";

      window.socketClient = socketClient;

      document.querySelector(".chat-box").addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          const message = e.target.textContent;
          e.target.textContent = "";
          socketClient.setData(
            `chat`,
            {
              message,
              emoji: socketClient.self.state.emoji,
              name: socketClient.self.state.name,
            },
            {
              push: true,
            }
          );
          e.preventDefault();
        }
      });

      socketClient.observe(["chat"]).onElementsAdded((elems) => {
        elems.forEach((elem) => {
          const chatLog = document.querySelector(".chat-log");
          const chatEntry = chatLog.appendChild(document.createElement("div"));
          chatEntry.style.display = "flex";
          chatEntry.style.gap = "10px";
          chatEntry.style.flexDirection = "row";
          const chatAuthor = chatEntry.appendChild(
            document.createElement("div")
          );
          chatAuthor.textContent = `${elem.emoji} ${elem.name}`;
          chatAuthor.style.fontWeight = "bold";
          const chatMessage = chatEntry.appendChild(
            document.createElement("div")
          );
          chatMessage.textContent = `${elem.message}`;
          chatLog.scrollTop = chatLog.scrollHeight;
        });
      });

      socketClient.observe(["clients/{self}"]).onChange(() => {
        socketClient.self.setData("name", randomName());
        socketClient.self.setData("emoji", randomEmoji());
      });

      socketClient
        .observe(["clients/{keys}"])
        .onElementsAdded((clientIds) => {
          clientIds.forEach((clientId) => {
            socketClient
              .observe([
                `clients/${clientId}/name`,
                `clients/${clientId}/emoji`,
              ])
              .onChange((name, emoji) => {
                client.textContent = `${emoji.value} ${name.value}`;
                if (!emoji.value && !name.value) {
                  observer.close();
                }
              });

            // new client
            const client = document.createElement("div");
            client.id = `client-${clientId}`;
            client.textContent = clientId;
            if (clientId === socketClient.clientId) {
              client.style.fontWeight = "bold";
              client.style.backgroundColor = "yellow";
              document.querySelector(".users").prepend(client);
            } else {
              document.querySelector(".users").appendChild(client);
            }
          });
        })
        .onElementsDeleted((clientIds) => {
          clientIds.forEach((clientId) => {
            const client = document.querySelector(`#client-${clientId}`);
            client.style.transition = "opacity 0.3s";
            client.style.opacity = 0;
            setTimeout(() => {
              client.remove();
            }, 300);
          });
        });
    </script>
  </body>
</html>

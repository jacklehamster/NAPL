<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>YouTube Room</title>
    <style>
      body {
        background-color: lightgray;
      }
      .cursor {
        position: absolute;
        width: 20px;
        height: 20px;
        font-size: 20px;
        pointer-events: none;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div id="video" style="cursor: pointer">
        <iframe
          style="pointer-events: none"
          id="ytplayer"
          width="560"
          height="315"
          src="https://www.youtube.com/embed/u30MbFhLLvw?controls=0&enablejsapi=1&mute=1"
          frameborder="0"
        ></iframe>
      </div>
    </div>
    <div id="client-list"></div>
    <script type="module">
      import {
        trackCursor,
        trackCursorObserver,
        handleUsersChanged,
        introduceName,
        socketClient,
        stringify,
      } from "../dist/index.js";

      introduceName();

      function getOrCreateClientBox(clientId, isSelf) {
        if (document.querySelector(`#client-${clientId}`)) {
          return document.querySelector(`#client-${clientId}`);
        }
        const clientBox = document.createElement("div");
        clientBox.id = `client-${clientId}`;
        clientBox.classList.add("client-box");
        clientBox.style.backgroundColor = isSelf ? "lightgreen" : "lightblue";

        if (isSelf) {
          document.querySelector("#client-list").prepend(clientBox);
        } else {
          document.querySelector("#client-list").appendChild(clientBox);
        }
        return clientBox;
      }

      trackCursor();

      //  Cursor
      handleUsersChanged((clientId, isSelf, observers) => {
        const clientBox = getOrCreateClientBox(clientId, isSelf);
        //  cursor
        const cursorDiv = clientBox.appendChild(document.createElement("div"));
        cursorDiv.id = `cursor-${clientId}`;
        cursorDiv.classList.add("cursor");

        observers.add(
          socketClient
            .observe(`clients/${clientId}/emoji`)
            .onChange((emoji) => (cursorDiv.textContent = emoji.value))
        );

        observers.add(
          trackCursorObserver(clientId, (cursor) => {
            if (!cursor) {
              cursorDiv.style.display = "none";
              return;
            }
            const [x, y] = cursor;
            cursorDiv.style.display = "block";
            cursorDiv.style.left = `${x - 10}px`;
            cursorDiv.style.top = `${y - 20}px`;
          })
        );
      });

      document.querySelector("#video").addEventListener("click", () => {
        socketClient.setData("videoPlaying", (playing) => !playing);
        socketClient.setData("videoStarted", "~{serverTime}");
      });

      socketClient.observe("videoPlaying").onChange((videoPlaying) => {
        const player = window.player;
        if (videoPlaying.value) {
          player.playVideo?.();
        } else {
          player.pauseVideo?.();
        }
      });

      socketClient
        .observe()
        .onChange(() => console.log(stringify(socketClient.state)));
    </script>
    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
      let player;

      function onPlayerStateChange(event) {
        if (event.data == YT.PlayerState.ENDED) {
          console.log("ENDED");
        }
      }

      // Create a YouTube player instance.
      function onYouTubeIframeAPIReady() {
        player = new YT.Player("ytplayer", {
          events: {
            onStateChange: onPlayerStateChange,
          },
        });
        window.player = player;
      }
    </script>
  </body>
</html>
